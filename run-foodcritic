#!/usr/bin/env ruby

def main(argv: ARGV)
  return 1 if argv.empty?

  failed = []

  cookbook_path = argv.first
  fc_args = %W(#{ENV['FC_ARGS']})
  fc_tags = ENV['FC_TAGS'] || File.join(cookbook_path, '.foodcritic-tags')
  quiet = !!ENV['QUIET']

  if File.exist?(fc_tags)
    fc_args += File.read(fc_tags).split.map { |t| "--tags #{t.strip}" }
  end

  Dir.glob("#{cookbook_path}/*") do |cookbook|
    next unless File.directory?(cookbook)
    cookbook_name = File.basename(cookbook)
    next if cookbook_name == 'cookbooks'

    foodcritic_command = %W(
      foodcritic
        --epic-fail any
        #{fc_args.join(' ')}
        #{cookbook}
    ).join(' ')

    puts "---> #{cookbook_name}: #{foodcritic_command}" unless quiet

    output = `#{foodcritic_command} 2>&1`.chomp
    output = output.split(/[\r\n]/).map(&:strip).reject(&:empty?).join("\n")
    puts output unless output.empty?

    if $?.success?
      puts "---> #{cookbook_name} ✔︎" unless quiet
    else
      puts "---> #{cookbook_name} ✘" unless quiet
      failed << cookbook_name
    end
  end

  puts "FAILED:\n#{failed.join(' ')}" unless failed.empty?

  0
end

exit(main) if $PROGRAM_NAME == __FILE__
