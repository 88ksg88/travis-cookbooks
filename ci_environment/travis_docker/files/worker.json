{
  "builders": [
    {
      "type": "amazon-ebs",
      "ami_name": "worker {{ timestamp }}",
      "region": "us-east-1",
      "source_ami": "ami-fe379296",
      "instance_type": "c3.2xlarge",
      "ssh_username": "ubuntu",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} sudo -E bash '{{ .Path }}'",
      "inline": [
        "export DEBIAN_FRONTEND=noninteractive",
        "wget -qO- https://get.docker.io/gpg | apt-key add -",
        "echo deb http://get.docker.io/ubuntu docker main > /etc/apt/sources.list.d/docker.list",
        "apt-get update",
        "apt-get install -y lxc wget bsdtar curl make openjdk-7-jdk",
        "apt-get install -y linux-image-extra-$(uname -r)",
        "modprobe aufs",
        "apt-get install -y lxc-docker-1.2.0",
        "useradd --create-home --groups docker travis",
        "echo 'DOCKER_OPTS=\"--exec-driver=lxc --icc=false -H tcp://127.0.0.1:4243 -H unix:///var/run/docker.sock -g=/mnt/docker\"' >> /etc/default/docker",
        "sed -i 's/GRUB_CMDLINE_LINUX=\"\"/GRUB_CMDLINE_LINUX=\"cgroup_enable=memory swapaccount=1\"/' /etc/default/grub",
        "service docker stop",
        "service docker start"
      ]
    },
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} sudo -u travis -E bash '{{ .Path }}'",
      "inline": [
        "export HOME=/home/travis",
        "cd ~",
        "wget -O ruby-install-0.4.3.tar.gz https://github.com/postmodern/ruby-install/archive/v0.4.3.tar.gz",
        "tar -xzvf ruby-install-0.4.3.tar.gz",
        "cd ruby-install-0.4.3/",
        "PREFIX=/home/travis/local make install",
        "~/local/bin/ruby-install jruby 1.7.13 --no-install-deps",
 
        "cd ~",
        "wget -O chruby-0.3.8.tar.gz https://github.com/postmodern/chruby/archive/v0.3.8.tar.gz",
        "tar -xzvf chruby-0.3.8.tar.gz",
        "cd chruby-0.3.8/",
        "PREFIX=/home/travis/local make install",
 
        "cd ~",
        "echo 'source /home/travis/local/share/chruby/chruby.sh' >> ~/.bashrc ",
        "source /home/travis/local/share/chruby/chruby.sh",
        "chruby jruby",
 
        "gem install bundler",
 
        "git clone https://github.com/travis-ci/travis-worker.git",
        "cd travis-worker",
        "bundle install --deployment --binstubs --retry=3 --jobs=3"
      ]
    },
    {
      "type": "file",
      "source": "docker_rsa",
      "destination": "/tmp/docker_rsa"
    },
    {
      "type": "shell",
      "execute_command": "{{ .Vars }} sudo -u travis -E bash '{{ .Path }}'",
      "inline": [
        "export HOME=/home/travis",
        "mkdir ~/.ssh",
        "chmod 0700 ~/.ssh",
        "mv /tmp/docker_rsa ~/.ssh",
        "chmod 0600 ~/.ssh/docker_rsa"
      ]
    }
  ]
}